.. sectionauthor:: Артём Светлов <artem.svetlov@nextgis.ru>

.. _howto_steppe_fire_sentinel:

Определение площади степного пожара по космоснимкам Sentinel-2
================================================================

Введение
----------------------------

В этой инструкции мы скачаем космоснимок Sentinel-2 в tiff, 
настроим контрастность и цвета, 
обведём территорию затронутую степным пожаром,
и узнаем её площадь.
 
Для работы потребуется:

#. :program:`NextGIS QGIS`.
#. Веб бразуер.


В 2016 году в мире существуют несколько программ предоставления доступа к материалам спутниковой съёмки, достаточной для того, что бы определить по ней сгоревшие территории. В степях сгоревшие участки хорошо видны в обычном оптическом диапазоне. Мы можем бесплатно воспользоваться материалами Landsat (предоставляются NASA и USGS) и Sentinel-2 (предоставляются Европейским космическим агенством). Эти космоснимки можно использовать бесплатно. Спутники снимают каждую территорию через несколько дней, и мы можем отобрать снимки на нужные даты и с достаточным уровнем облачности.

Пространственное разрешение у спутника Landsat-8: 30 м/пикс для всех каналов и 15 м/пикс для панхроматического канала.

Пространственное разрешение у спутника Sentinel-2A: 10 м/пикс для всех каналов.


Получение данных Sentinel-2A
----------------------------

Данные можно скачать на нескольких сервисах (например, https://scihub.copernicus.eu/dhus/#/home)
В инструкции мы воспользуемся сервисом http://earthexplorer.usgs.gov - 
Геологической службы США.
.. note:: На https://scihub.copernicus.eu/dhus снимки появляются быстрее, а на http://earthexplorer.usgs.gov они нарезаны на более мелкие сцены, и тот сервис предоставляет менеджер скачки, это удобно при плохом интернете.

Для скачивания данных нужно зарегистрироваться на сервисе.


Информация о наборе данных: 
USER NOTICE:  Sentinel-2 Products from USGS
The Sentinel-2 data were acquired, processed, and generated by the European Space Agency (ESA) and repackaged by USGS into tile-based bundles.  For more information on the available Sentinel-2 products and distribution from USGS, please visit: http://eros.usgs.gov/sentinel-2. 
All Sentinel-2 data products are provided under the terms and conditions prescribed by the European Commission’s Copernicus Programme.  For detailed information on data policy, appropriate usage, and citation of Sentinel data, click on this link: https://lta.cr.usgs.gov/sites/default/files/Sentinel_Data_Terms_and_Conditions.pdf
IMPORTANT: The USGS Sentinel-2 archive is a partial representation of all available acquisitions from ESA. Users should expect a delay before ESA’s acquisitions become available on EarthExplorer. For detailed information on the Sentinel-2 mission and data access available from ESA, please visit: https://sentinel.esa.int/web/sentinel/missions/sentinel-2

Чтобы получить данные, необходимо задать географическую область.

.. figure:: _static/reliefEarthExplorer01.png
   :name: howto_reliefEarthExplorer01
   :align: center
   :width: 15cm

   Установка области для поиска данных.

Переключиться на закладку :guilabel:`Data Sets` (наборы данных) и выбрать в 
группе :guilabel:`Sentinel` - :guilabel:`Sentinel-2`.

.. figure:: _static/sentinelEarthExplorer02.png
   :name: howto_sentinelEarthExplorer02
   :align: center
   :width: 15cm

   Выбор набора данных Sentinel-2.


Для перехода к просмотру данных необходимо нажать кнопку **Results**.

.. figure:: _static/sentinelEarthExplorer03.png
   :name: howto_sentinelEarthExplorer03
   :align: center
   :width: 15cm
   
   Фрагмент окна результатов поиска снимков по заданной территории.

В списке результатов указываются даты снимков. Нажатием кнопки :guilabel:`Show browse overlay` можно 
посмотреть, как ложится проекция сцены на карту, и не закрывают ли облака нужное место. Нажатием кнопки 
:guilabel:`Download options` будет начат процесс скачивания.


.. figure:: _static/sentinelEarthExplorer04.png
   :name: howto_sentinelEarthExplorer04
   :align: center
   :width: 15cm
   
   Выбор вариантов скачивания: вся сцена, или файл предпросмотра. Выберите тот, у которого больше размер.

Если нужно скачать несколько снимков, то следует учесть, что на данный момент в
Earth Ezplorer существует ошибка: при возврате со страницы скачивания в карту на 
экране висит надпись "Searcing", и ничего не происходит. Если необходимо скачать
большое количество снимков, то можно воспользоваться специальным java-приложением
распространяемым тут же на сайте.

Космоснимок называется "сцена", он скачивается в архиве. Распакуйте архив.

Открытие одного канала (простой способ)
----------------------------------------------

* Если вы скачали снимок со спутника Landsat-8, то откройте в QGIS растровый файл из архива, который оканчивается на _B8.tif

.. figure:: _static/howto_sentinelOpenLandsat.png
   :name: howto_sentinelOpenLandsat
   :align: center
   :width: 15cm
   
   При открытии снимка Landsat-8 выбирайте этот файл.
   
* Если вы скачали снимок со спутника Sentinel-2B, то откройте в QGIS растровый файл из архива, который лежит в нём по адресу /GRANULE.../IMG_DATA/ и оканчивается на _B03.JP2

Настройте контрастность картинки. Для этого
1. Передвиньте карту на то место, где видны следы пожара.
2. Выделите слой с космоснимком в списке слоёв.
3. В контекстном меню слоя Свойства --> Стиль. Выставите настройки как на howto_sentinelEarthExplorer04

.. figure:: _static/howto_sentinelStyleBW1.png
   :name: howto_sentinelStyleBW1
   :align: center
   :width: 15cm
   
   Настройки стиля для чёрно-белого снимка

4. Найдите в окне раздел "Значения мин/макс"и в нём нажмите кнопку "Загрузить". 



Контрастность растянулась. Особенно полезен этот способ когда на снимке есть облака.

.. note:: 
В файле яркость точек записана в диапазоне от 0 до 16000. А на мониторе она изменяется более грубо: от 0 до 255. При этой операции самыё тёмно-серые места на снимке станут чёрными, а самые светло-серые станут белыми.

Создание цветного изображения (сложный способ)
--------------------------------------------------------

В архиве в находятся отдельные tiff-файлы, по одному на канал. 

.. note:: 

    Что такое канал? 
    Камера в вашем телефоне выдаёт трёхканальные фотоснимки: у каждого пиксела записаны значения красного, зелёного и синего цветов, и на светочуствительной матрице в камере находятся датчики трёх типов.
    Спутник Sentinel-2A выдаёт 11-канальные фотоснимки, на нём находится много светочуствительных датчиков. Длинны волн, которые они снимают известны, таблицу их значений можно найти в интернете. Каналы №2, 3, 4 - снимают в видимом диапазоне. Известно, что если считать канал №4 красным, №3 - зелёным, №2 - синим, то из этих трёх каналов можно собрать цветное изображение.

QGIS --> Растровые операции --> Объединение.
Из пачки tiff получится 1 tiff мультиканальный
Открыть мультиканальный tiff
Свойства слоя --> Стиль --> Многоканальное цветное. Выставите контрастность как на картинке.


Рисование площади сгоревшего участка
---------------------------------------------

* Определите зону UTM. Слой снимка --> Контекстное меню слоя --> Свойства --> Общие --> Вкладка "Система координат".  В примере у снимка система координат EPSG:32640, запомним это название.

.. figure:: _static/howto_sentinelDrawCRS.png
   :name: howto_sentinelDrawCRS
   :align: center
   :width: 15cm
   
* Создать новый слой. Система координат - та же, что на предыдущем шаге. Тип геометрии - мультиполигон. 

.. figure:: _static/howto_sentinelCreateVectorLayer.png
   :name: howto_sentinelCreateVectorLayer
   :align: center
   :width: 15cm
   
   
.. figure:: _static/howto_sentinelCreateVectorLayer2.png
   :name: howto_sentinelCreateVectorLayer2
   :align: center
   :width: 15cm
   
* Создание атрибутов пропустить
* Выберите папку, куда сохранятся файлы слоя.
* Включить панели Рисование
* Начать рисовать.
* Сделать слой полупрозрачным, или линией. Слой --> Свойства --> Стиль. Сделайте цвет полупрозрачным.

* Если в территории дырка: на панели "Дополнительные инструменты рисования" нажмите кнопку "Добавить кольцо". Обрисуйте несгоревший участок. 
* Выйдите из режима редактирования слоя. 
* Для подсчёта площади воспользуйтесь инструкцией по ссылке http://docs.nextgis.ru/docs_ngqgis/source/editing.html#id4
* Сохраните файл geojson, что бы потом на следующий год его не потерять. 
