.. sectionauthor:: Артём Светлов <artem.svetlov@nextgis.ru>

.. _howto_vector_ref:

Привязка векторного слоя к растровому или к другому векторному слою
==========================================================================

Введение
---------

Эта инструкция описывает как можно привязать векторный слой к другому слою, используя gcp и ogr2ogr.

gcp - это Ground Control Points, точки с координатами в географической системе координат, и в другой системе координат, например пикселов на изображении. Термин gcp часто используется в софте и утилитах для работы с координатами.

Примеры:

Можно взять векторный слой с дорожным графом, и привязать его к фотографии города сделанной из самолёта. Тогда получится векторный слой, у которого в качестве координат будут координаты пикселов фотографии.

Можно взять растровое изображение карты, и не привязвать растр к вектору, а векторизовать непривязанную карту (у вас получится векторный файл где в координатах будут записаны координаты пикселов, и првиязать его к географическим координатам по точкам)



Возьмём растровую карту 
https://commons.wikimedia.org/wiki/File:Orekhovo-Zuevo_map_1925_(22370728927).jpg

Карта 

Добавляем её в новый проект в NextGIS QGIS. На запросы системы координат отвечаем Cancel, проверяем что в проекте не включено преобразование координат на лету. Если всё правильно, то на экране должна быть карта как есть, а координаты курсора должны показываться в пикселах карты

Проверьте выделенные поля

Теперь нужно создать векторный слой в системе координат изображения. Укажите систему координат EPSG:4326. Мы будем помнить, что на самом деле она локальная, а не географическая. В принципе можно было бы создать Shapefile без prj, но для простоты инструкции это пропущено.

Векторизуем чего-нибудь по карте в нашем новом векторном слое.

Теперь нужно составить набор gcp. GUI для этого ещё никто не заказал, поэтому придётся вручную. 

Ставьте наш плагин copy_coords

.. figure:: _static/vector_georefrencing_copy_coords.png
   :name: vector_georefrencing_copy_coords
   :align: center
   :width: 10cm
   

Добавляйте через qms подложку

проверяйте что otf выключено

щёлкаете точку на растровой карте  копируйте координаты в электронную таблицу

Нажимаете "увелиичить до слоя" на подложке из QMS, щёлкаете точку, копируйте координаты в электронную таблицу

курим мануал по ogr2ogr: https://www.gdal.org/ogr2ogr.html

Аргументы имеющие отношения к gcp устроены так же как в gdalwarp

-gcp ungeoref_x ungeoref_y georef_x georef_y elevation:
Указание наземной контрольной точки. Этот ключ может быть повторён много раз для задания набора точек.
-order n
Задать алгоритм привязки - порядок полинома, используемый для привязки (1 до 3). По умолчанию выберется полином по количеству контрольных точек.
-tps:
Использовать алгоритм тонкостенный сплайн вместо полинома

Алгоритм тонкостенный сплан для наших задач подходит лучше других. Значение elevation можно пропускать.

Перенос строки в bash: знак \

Перенос строки в batch: знак ^

берёте notepad++ и составляете строку вызова ogr2ogr с gcp. Должно быть что-то вроде такого.
2782.06875	-1007.353125	38.9931560236	55.8110937342
2635.8890625	-1642.5703125	38.9937580329	55.8062260592
824.447118787	-2607.92029001	38.9752620143	55.7954988271

```
ogr2ogr -progress -f GeoPackage  -a_srs EPSG:3395 -tps -gcp 2782.06875	-1007.353125	38.9931560236	55.8110937342^
-gcp 2635.8890625	-1642.5703125	38.9937580329	55.8062260592^
-gcp 824.447118787	-2607.92029001	38.9752620143	55.7954988271^
d:\trolleway\2018-11_docs\vector_georefrencing\roads_refrenced.gpkg d:\trolleway\2018-11_docs\vector_georefrencing\roads_local.gpkg

ogr2ogr -progress -f GeoJSON blaeu_outline.geojson -a_srs EPSG:3395 -dsco ATTRIBUTES_SKIP=YES -order 1 -gcp 1571.29165 -4217.06023 -551760.015 7302342.218 -gcp 2729.71384 -4421.27506 -338736.496 7324447.924 -gcp 1477.31668 -3328.36427 -603897.130 7496225.431 -gcp 2011.25239 -3353.35609 -536774.862 7514805.007 -gcp 2021.23961 -3783.80519 -516238.228 7418369.368 -gcp 1386.05253 -2433.53330 -632410.002 7624335.089 -gcp 1609.76622 -1681.49577 -635963.491 7783695.427 -gcp 1732.60900 -1079.26651 -599335.214 7983647.549 -gcp 2102.13607 -655.80846 -556830.013 8062917.700 -gcp 2906.10714 -611.86470 -339110.443 8067291.226 -gcp 2974.02022 -753.68320 -340067.151 8031482.985 -gcp 2858.16849 -1518.70411 -423164.137 7901097.254 -gcp 2617.47653 -1878.74333 -470179.537 7823193.830 -gcp 3788.47786 -1882.73821 -224168.724 7866382.395 -gcp 3920.30914 -2064.50559 -200661.024 7828114.046 -gcp 3271.13996 -3004.30282 -288951.571 7635405.575 -gcp 3216.21026 -3254.98199 -289771.607 7578549.743 -gcp 2608.98740 -3372.33181 -415578.804 7531397.670 -gcp 3120.33297 -3431.75575 -312337.131 7534907.369 -gcp 3433.93162 -3683.43365 -238109.336 7506113.225 -gcp 3495.85237 -3831.74384 -222391.979 7477821.982 -gcp 2050.70190 -4455.44562 -457276.805 7286175.723 1654_Blaeu_map_of_scotland.shp
```
ogr2ogr должен создать векторный слой с географической системой координат
