.. sectionauthor:: Артём Светлов <@nextgis.ru>

.. LipetskRegEcoGIS:

Инструкция оператора системы ГИС ИАС экологической паспортизации МР и ГО Липецкой области
=============================================================================================

Введение
----------------------------

й


Описание ПО ГИС
----------------------------------------------

Комплекс ПО состоит из
* Рабочих мест оператора с настольной ГИС NextGIS QGIS - это программа под ОС Windows, в которой работают с геоданными.
* Серверной веб-гис NextGIS Web - это веб-сервер, который раздаёт геоданные по сети. Он может показывать геоданные на карте в браузере, изменять данные можно через веб-браузер, из NextGIS QGIS.


Работа с системой через настольный клиент
----------------------------------------------

Запуск приложения NextGIS QGIS
``````````````````````````````````````````````

Запускается как обычное приложение под Windows. Далее в нём нужно открыть сохранёный проект.

Работа с локальными слоями
``````````````````````````````````````````````
Геоданные бывают векторные и растровые.
Векторные данные обычно хранятся как электронная таблица, где у каждой записи есть своя геометрия - то есть фигура, заданная координатами точек. 
Растровые данные обычно хранятся как картинка, в которой указано, на какое место земного шара она ложится. 

Существует множество форматов хранения геоданных, и протоколов их передачи по сети. Они могут представлять собой файлы, или находится в базах данных. 
Преобразованием форматов занимаются утилиты GDAL (растровые) и OGR (векторные). Благодаря этим утилитам NextGIS QGIS может читать и записывать разные форматы данных без сильных различий для пользователя.
Разумеется, обычно используются только самые общеупотребительные форматы.  

Понятие Слой будет часто встречаться в инструкции. Слой - это то, что видно в списке слоёв, технически это один файл, или одна таблица в БД. 

Открытие SHP файлов
::::::::::::::::::::::::::::::::::::::::::::::

Стандартный формат векторных файлов используемый NextGIS QGIS называеся ESRI shapefile/


На самом деле, shape-файл состоит из нескольких файлов разных форматов. Из них три обязательны:

#. :file:`.shp` файл с геометриями
#. :file:`.dbf` файл с атрибутами в формате dBase
#. :file:`.shx` файл с индексом
#. :file:`.prj` файл с описанием проекции (не обязательно)

Так же могут прилагаться другие файлы.


Если у вас нет своих SHP-файлов, скачайте их для примера с http://beryllium.gis-lab.info/project/osmshp/. Если они в архиве - распакуйте их. 

.. figure:: _static/LREGQGISOpenShape1.png
   :name: sxfQGISSearchProjection
   :align: center
   :width: 15cm


.. figure:: _static/LREGQGISOpenShape2.png
   :name: sxfQGISSearchProjection
   :align: center
   :width: 15cm


.. figure:: _static/LREGQGISOpenShape3.png
   :name: sxfQGISSearchProjection
   :align: center
   :width: 15cm


Выбираем файл с расширением .shp

.. figure:: _static/LREGQGISOpenShape4.png
   :name: sxfQGISSearchProjection
   :align: center
   :width: 15cm

В середине 2010-х годов принято, что все данные сохраняются в кодировке UTF-8. При работе на ОС Windows при открытии и сохранении векторных данных нужно явно указывать кодировку UTF-8. По умолчанию она может быть System - это значит CP1251.
Если вы открыли файл в неправильной кодировке, то русские буквы там будут нечитаемыми. 


.. figure:: _static/LREGQGISOpenShape5.png
   :name: sxfQGISSearchProjection
   :align: center
   :width: 15cm


Векторные слои в QGIS могут быть точечные, линейные, или полигональные. Обычно в векторных файлах не сохраняется оформление, и при открытии он покрасится в случайный цвет. При желании можно настроить оформление, и сохранить оформление в формат qgs, с тем же именем что и векторный файл. Если файл стиля будет лежать в той же папке, то при открытии слоя NextGIS QGIS подхватит и стиль.
 

Если вы создали новый проект, и сразу же в него добавили слой, то он скорее всего он будет казаться сплюснутым по вертикали. Это потому, что как правило векторные геоданные хранятся в системе координат EPSG:4326 - в градусах. Что бы на карте не было искажений, нажмите на кнопку в правом нижнем углу, и в открывшемся окне выбора проекции в поиске введите 3857.
Это обозначает, что в QGIS включится преобразование координат на лету.

Проверьте, правильно ли он попадает в нужную местность. Интернет > QuickMapServices > OSM > OSM Mapnik, или любая другая подложка. 

- Если плагина QuickMapServices нет, то Модули > Управление модулями, в строке поиска ввести "QuickMapServices", и нажать галочку, либо кнопку "Установить".

Просмотр таблицы атрибутов
::::::::::::::::::::::::::::::::::::::::::::::

У векторных слоёв есть атрибуты. Их можно смотреть в таблице. 

.. figure:: _static/LREGQGISAttributeTable1.png
   :name: sxfQGISSearchProjection
   :align: center
   :width: 15cm

Одна запись в таблице - это один объект в слое.
Столбцы - это атрибуты слоя. 
У каждого объекта есть геометрия, которая отображается на карте. 

Можно настроить, что бы таблица атрибутов открывалась в отдельном окне, а можно - что бы она всегда была внутри основного окна программы.


.. figure:: _static/LREGQGISAttributeTable2.png
   :name: sxfQGISSearchProjection
   :align: center
   :width: 15cm

.. figure:: _static/LREGQGISAttributeTable3.png
   :name: sxfQGISSearchProjection
   :align: center
   :width: 15cm

При желании легко можно настроить, что бы объекты из одного слоя но с разными атрибутами рисовались с разным оформлением. См. инструкции по QGIS.


В таблице атрибутов чаще всего используются следующие кнопки:

.. figure:: _static/LREGQGISAttributeTable4.png
   :name: sxfQGISSearchProjection
   :align: center
   :width: 15cm

   Кнопки в таблице атрибутов


1 - сортировка по полю

2 - включить режим редактирования слоя. Теперь в слое можно править значения, как в электронной таблице, и править геометрию.

3 - сохранить правки в этом слое (отдельно от сохранения всего проекта)

4 - Удалить выделенные обьекты.

5 - Снять выделение с объектов

6 - Переместить карту на выделеный объект или несколько объектов

7 - Изменить масштаб карты на выделенный объект или несколько объектов

8 - Копировать-вставить выделенные объекты (вместе с геометрией)

9 - Удалить или добавить атрибут (столбец)

10 - Запуск калькулятора полей - он добавляет новый столбец со значениями по форулам, как в Excel


.. figure:: _static/LREGQGISAttributeTableSearch.png
   :name: sxfQGISSearchProjection
   :align: center
   :width: 15cm

   Выражение для поиска обьектов в слое по значениям

Идентификация объектов
::::::::::::::::::::::::::::::::::::::::::::::



.. figure:: _static/LREGQGISIdentify.png
   :name: LREGQGISIdentify
   :align: center
   :width: 15cm

Выберите инструмент идентификации. Щёлкните на каком-нибудь объекте. На экран выведутся его атритуты. В панели инструментов "Результат определения" (4) можно настроить, что именно будет показываться на экране при нажатии: будет ли открываться отдельное окно, или нет.


Рядом есть жёлтая иконка - выделения объектов. Она выделяет объекты в том слое, который выбран в меню слоёв. Выделеные объекты подсвечиваются в таблице атрибутов, их можно скопировать или удалить. 
Выделять можно по клику, или обводя область рамкой. Может быть выделено несколько объектов по очереди с нажатой клавишей Ctrl.   
Правее - кнопка "Снять выделение".

.. figure:: _static/LREGQGISSelect.png
   :name: LREGQGISIdentify
   :align: center
   :width: 15cm
   
   Выделение нескольких объектов. В таблице атрибутов - режим "Выделенные объекты".

Создание новых SHP файлов
::::::::::::::::::::::::::::::::::::::::::::::

Есть 2 способа:

#. :menuselection:`Слой --> Создать слой --> Создать Shapefile`. Указать атрибуты, и создать.
#. :menuselection:`Слой --> Создать слой --> Создать временный защитный слой`. Добавить в него атрибуты, и сохранить как SHP файл.

Второй способ появился недавно, поэтому его нет в основной инструкции. Он удобнее.

.. figure:: _static/LREGQGISCreateLayer1.png
   :name: LREGQGISIdentify
   :align: center
   :width: 15cm

.. figure:: _static/LREGQGISCreateLayer2.png
   :name: LREGQGISIdentify
   :align: center
   :width: 15cm

Указываем тип геометрии. При выборе проекции: Если не указано иное, то выбирайте наиболее распространённую EPSG:4326

В списке слоёв у вас должен появится новый слой.

Чаще всего, мы хотим хранить в векторном слое какие-нибудь данные, поэтому сначала добавляем атрибуты.


.. figure:: _static/LREGQGISCreateLayer3.png
   :name: LREGQGISIdentify
   :align: center
   :width: 15cm

Выделяем временный слой в списке слоёв.

Включаем таблицу атрибутов

Проверяем, включён ли временный слой в режим редактирования.

Нажимаем на кнопку "Добавить поле"


.. figure:: _static/LREGQGISCreateLayer4.png
   :name: LREGQGISIdentify
   :align: center
   :width: 15cm

У атрибутов должен быть задан тип. В разных форматах файлов типы немного отличаются, но в основном они таковы:

*. Текстовый
*. Целое число
*. Десятичное число
*. Дата (со временем)

В формате SHP размер текстового поля ограничен 255 символами. Если ваши значения не влезают в такое ограничение - сохраняйте в формат GeoJSON. В нём нет такого ограничения, но он занимает больше места, в нём нельзя редактировать, в нём нет индексов (медленнее читается).

У десятичного числа: поле "размер" обозначает , поле "точность" - количество 


Теперь можно начинать рисовать. 

.. figure:: _static/LREGQGISCreateLayer5.png
   :name: LREGQGISIdentify
   :align: center
   :width: 15cm

Во время рисования можно двигать карту нажатием колеса мыши. Завершение рисования - по нажатию правой кнопки мыши.
Затем откроется окно ввода атрибутов.
После рисования - не забудьте сохранить правки слоя. 

При рисовании можно использовать прилипание - что бы края обьекта прилегали к другому, уже существующему объекту. 
Можно рисовать площадные объекты с дырками посредине.
Можно рисовать мультиобъекты (например территория РФ имеет анклав - Калининградская область, но нам нужно, что бы вся страна считалась одним объектом, а не двумя).
Подробнее - см. http://docs.qgis.org/2.8/ru/docs/training_manual/create_vector_data/index.html


После рисования нужно сохранить временный защитный слой в формат Shapefile. Сохранять в Shapefile слой без геометрии не получится, поэтому сначала добавьте хотя бы один объект.


.. figure:: _static/LREGQGISSave2SHP1.png
   :name: LREGQGISIdentify
   :align: center
   :width: 15cm

.. figure:: _static/LREGQGISSave2SHP2.png
   :name: LREGQGISIdentify
   :align: center
   :width: 15cm

При сохранении обратите внимание: рекомендуется сохранять в системе координат EPSG:4326 и кодировке UTF-8. Это позволит вашим файлам быть наиболее переносимыми.

Работа со слоями на сервере
``````````````````````````````````````````````

Из QGIS можно работать с NextGIS Web напрямую. Можно смотреть и редактировать данные.

Настройка подключения к NextGIS Web серверу через NGW Connect
::::::::::::::::::::::::::::::::::::::::::::::

:menuselection:`Модули --> NGW Connect --> Показать панель`.

- Если плагина NGW Connect нет, то :menuselection:`Модули --> Управление модулями`, в строке поиска ввести "NGW Connect", и нажать галочку, либо кнопку "Установить".
- Если плагин не находится, то нужно подключить репозиторий модулей NextGIS http://nextgis.ru/programs/qgis/qgis-repo.xml


.. figure:: _static/LREGNGWConnect1.png
   :name: LREGQGISIdentify
   :align: center
   :width: 15cm

.. figure:: _static/LREGNGWConnect2.png
   :name: LREGQGISIdentify
   :align: center
   :width: 15cm

.. figure:: _static/LREGNGWConnect3.png
   :name: LREGQGISIdentify
   :align: center
   :width: 15cm




Просмотр дерева слоев на сервере
::::::::::::::::::::::::::::::::::::::::::::::

Добавление WFS слоев на карту
::::::::::::::::::::::::::::::::::::::::::::::

Редактирование слоев геоданных
``````````````````````````````````````````````

Добавление нового объекта
::::::::::::::::::::::::::::::::::::::::::::::

Изменение геометрии существующего объекта
::::::::::::::::::::::::::::::::::::::::::::::

Изменение атрибутов существующего объекта
::::::::::::::::::::::::::::::::::::::::::::::

Удаление объекта
::::::::::::::::::::::::::::::::::::::::::::::

Копирование объектов из одного слоя в другой
::::::::::::::::::::::::::::::::::::::::::::::



Работа с системой через WEB интерфейс
----------------------------------------------

Вход на основную страницу сайта
``````````````````````````````````````````````

Вход в административный интерфейс сайта
``````````````````````````````````````````````

Создание группового ресурса
``````````````````````````````````````````````

Работа с векторными слоями
``````````````````````````````````````````````

Загрузка SHP файла на сервер
::::::::::::::::::::::::::::::::::::::::::::::

Настройка векторного слоя
::::::::::::::::::::::::::::::::::::::::::::::

Настройка стиля для векторного слоя
::::::::::::::::::::::::::::::::::::::::::::::

Работа с веб-картами
``````````````````````````````````````````````

Создание новой веб-карты
::::::::::::::::::::::::::::::::::::::::::::::

Редактирование существующей веб-карты
::::::::::::::::::::::::::::::::::::::::::::::

Включение\выключение слоев
''''''''''''''''''''''''''''''''''''''''''''''

Переименование слоев
''''''''''''''''''''''''''''''''''''''''''''''

Добавление векторного слоя на карту
''''''''''''''''''''''''''''''''''''''''''''''

Удаление векторного слоя с карты
''''''''''''''''''''''''''''''''''''''''''''''

Создание, переименование и удаление группы слоев
''''''''''''''''''''''''''''''''''''''''''''''

Редактирование основной веб-карты сайты
::::::::::::::::::::::::::::::::::::::::::::::

Изменение основной карты
''''''''''''''''''''''''''''''''''''''''''''''

Работа со слоем районы Липецкой области
''''''''''''''''''''''''''''''''''''''''''''''

Работа со слоем Стационарные посты наблюдения
''''''''''''''''''''''''''''''''''''''''''''''

Редактирование информации через веб интерфейс
----------------------------------------------

Открытие таблицы объектов из административного интерфейса
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

Открытие карточки объекта из административного интерфейса
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

Открытие таблицы объектов из веб-карты
::::::::::::::::::::::::::::::::::::::::::::::

Открытие карточки объекта из веб-карты
::::::::::::::::::::::::::::::::::::::::::::::






Подготовка sxf к загрузке
----------------------------

Скачайте на странице http://www.gisinfo.ru/price/price_map.htm выгрузку данных OpenStreetMap на любой интересующий вас регион.

.. figure:: _static/sxfDownloadSample.png
   :name: sxfDownloadSample
   :align: center
   :width: 15cm


Распакуйте их в каталог.
Поскольку :program:`NextGISWEB` сейчас поддерживает импорт только из форматов ESRI Shapefile и geojson, то нам нужно сконвертировать sxf в geojson. 

Запустите :program:`NextGIS QGIS`.

Нажмите :menuselection:`Слой --> Добавить слой --> Добавить векторный слой`.


.. figure:: _static/sxfQGISOpenLayerDialog.png
   :name: sxfQGISOpenLayerDialog
   :align: center
   :width: 15cm

На экране появится диалог выбора слоёв из файла sxf. В этом примере мы загрузим слой железных дорог (Railway) и землепользования (landuse)

.. figure:: _static/sxfQGISOpenSXFLayers.png
   :name: sxfQGISOpenSXFLayers
   :align: center
   :width: 15cm

Сохраните эти два слоя в формате geojson. Для этого, выделите слой landuse в списке слоёв, и нажмите Нажмите :menuselection:`Слой --> Сохранить как`


.. figure:: _static/sxfQGISSaveLayerMenu.png
   :name: sxfQGISSaveLayerMenu
   :align: center
   :width: 15cm

В диалоге сохранения задайте следующие настройки:

#. Формат - geojson
#. Система координат - EPSG:4326. Если её не будет в предложенном списке (такое бывает при первом запуске программы), то нажмите на кнопочку рядом, и в окне поиска введите "4326".
#. Кодировка - если вы работаете под ОС :program:`Windows`, то выставьте UTF-8. Если вы работаете под ОС :program:`GNU/Linux`, то оставьте в нём System, по умолчанию.


.. figure:: _static/sxfQGISSaveDialog.png
   :name: sxfQGISSaveDialog
   :align: center
   :width: 15cm

   Окно экспорта слоя


.. figure:: _static/sxfQGISSearchProjection.png
   :name: sxfQGISSearchProjection
   :align: center
   :width: 15cm

   Окно поиска проекции

Сохраните слои как landuse.geojson и railway.geojson.


Особенность формата SXF - типы дорог там записаны числами. 

Эти числа - дробного типа. 

В картостиле дробные числа нельзя сравнивать оператором "=". 

Для того, что бы написать логичный картостиль, нужно преобразовать числа в целочисленный тип.

Эту операцию можно сделать разными способами: в NextGIS QGIS используя калькулятор полей и создание новых слоёв, либо в текстовом редакторе удалить из geojson автозаменой все включения ".000000".


Загрузка в NextGIS Web
----------------------------------

Откройте в браузере имеющийся у вас адрес инстанса, введите логин и пароль. Вы попадёте в админку. При желании вы можете создать в ней каталог ("группу ресурсов"), что бы работать с тестовыми данными в ней. Затем нажмите :guilabel:`Векторный слой`

.. figure:: _static/sxfNGWMainPage.png
   :name: sxfNGWMainPage
   :align: center
   :width: 15cm

   Главная страница админки

Задайте название "Землепользование". Перейдите на вкладку :guilabel:`Векторный слой`, нажмите на кнопку :guilabel:`Выбрать`, и загрузите файл landuse.geojson, затем нажмите на кнопку :guilabel:`Создать`.


.. figure:: _static/sxfNGWLayerUpload1.png
   :name: sxfNGWLayerUpload1
   :align: center
   :width: 15cm


.. figure:: _static/sxfNGWLayerUpload2.png
   :name: sxfNGWLayerUpload2
   :align: center
   :width: 15cm


Стилизация слоя в NextGIS Web
----------------------------------

Сейчас вы загрузили слой в NGW, для показа на веб-карте, или раздачи по WMS к нему нужно добавить стиль. 

Идите в :program:`NextGIS QGIS`.

Зайдите в свойства слоя Landuse, который вы экспортировали. Настройте его стиль - с классификацией по полю SC_20013.

.. figure:: _static/sxfQGISLayerStyleSettings.png
   :name: sxfQGISLayerStyleSettings
   :align: center
   :width: 15cm

Найдите снизу окна настроек слоя кнопку :menuselection:`Стиль --> Сохранить стиль --> Файлы стилей QGIS`. У вас сохранится стиль в формате qml.

.. figure:: _static/sxfQGISSaveQML.png
   :name: sxfQGISSaveQML
   :align: center
   :width: 15cm

Вернитесь в браузер. 
Сейчас вы находитесь в админке внутри слоя (если занудно - в окне свойств слоя), поэтому нажмите :guilabel:`Стиль Mapserver`.

Задайте стилю имя "Землепользование". Перейдите на вкладку :guilabel:`Mapserver`.

Нажмите кнопку  :guilabel:`Import QGIS style` (над текстовым полем). Выберите файл qml. После подтверждения, нажмите на кнопку :guilabel:`Создать`.

Показ слоя на веб-карте в NextGIS Web
------------------------------------------

Перейдите в список ресурсов, и Нажмите :guilabel:`Веб-карта`. Задайте название, и перейдите на вкладку :guilabel:`Слои`. Нажмите на кнопку :guilabel:`Добавить слой`, и выберите в списке ресурсов слои тех слоёв, что вы создали.

Нажмите на кнопку :guilabel:`Создать`.

Нажмите на кнопку :guilabel:`Просмотр`.

После этого шага в экране браузера появится веб-карта. Включите слой. 


