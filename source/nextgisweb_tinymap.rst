.. sectionauthor:: Артём Светлов <@nextgis.ru>

.. nextgisweb_tinymap:

nextgisweb_tinymap
=====================================

Введение
----------------------------

nextgisweb_tinymap - это несложный картодвижок на основе LeafletJS, который можете разместить на своём веб-сайте, чтобы показывать в нём векторный слой из NextGIS WEB. Слой добавляется в LeafletJS как GeoJSONLayer, в нём работает идентификация, показ названий и фотографий.

 

[s]Live demo: http://nextgis.github.io/nextgisweb_tinymap/[s] Не работает, нет сервера


Реализованные возможности
------------------------------------

- [x] Иконки для точек
- [x] Окно идентификации
- [x] При идентификации поля называются по псевдонимам, которые берутся из настроек слоя NextGIS WEB
- [x] При идентификации убираются скрытые поля - это берётся из настроек слоя NextGIS WEB
- [x] При идентификации показываются название объекта - это берётся из настроек слоя NextGIS WEB
- [x] При идентификации показываются фотографии объектов
- [x] Строка аттрибуции задаётся к конфигурационном файле.
- [x] Функция Leaflet PointToLayer хранится в отдельном файле стиля - при обновлении из репозитория ваш движок не поломается
- [x] При идентификации автоматически выделяются гиперссылки.



Установка
--------------------

 1. Склонируйте репозиторий

  ```
  git clone https://github.com/nextgis/nextgisweb_tinymap.git
  ```

 2. Переименуйте файл config.example.js в config.js
 3. Откройте файл config.js 
    Укажите в нём свой NGWLayerURL и строку аттрибуции

  ```
  NGWLayerURL: 'http://example.com/ngw/api/resource/31',
  NGWLayerAttribution:'<a href="http://corboration.com/">Источник данных</a>',
  ```

 4. Выставите права в NextGIS Web

Допустим, у нас в NGW такая структура: 

```
root
    L   Classifed data
    L   Open data
        L   somefolder 1
        L   somefolder 2
        L   data
            L   Your layer
```

```
Выставите в корне: Разрешить - Гость - Ресурс:Чтение - все ресурсы - нет
Выставите в группе следующей по уровню, то есть в Open data для гостя: Ресурс:Чтение, Структура данных:Чтение, Данные:Чтение. Метаданные:Чтение(?) - распространять.
```

 5.  Переименуйте файл tinymap.mapstyle.example.js в tinymap.mapstyle.js
 6. При необходимости вы можете настроить векторный стиль в файле tinymap.mapstyle.js. Это необязательно.

Охват карты вычисляется автоматически при открытии.





























В этой инструкции мы возьмём отсканированную топокарту Генштаба, определим её систему координат, и привяжем её по сетке, так что бы получился GeoTIFF.
Для работы потребуется:


#. Отсканиованная топокарта генштаба с зарамочным оформлением - там должны быть подписи.
#. :program:`NextGIS QGIS`.
#. Доступ к интернету, где мы будем скачивать разграфки и читать документацию.


Определяем проекции
----------------------------

Рассмотрим файл с картинкой карты в каком-либо графическом просмотрщике. Если у вас много больших растровых файлов, то для их просмотра можно использовать :program:`NextGIS Manager` - он открывает их быстрее, чем графические просмотрщики.

Нам нужно, чтобы на карте были не отрезано зарамочное оформление. 

.. figure:: _static/topo_smallmap.png
   :name: topo_smallmap
   :align: center

   Пример карты, подходящей для привязки по данной инструкции.

Для привязки карты нужно знать её проекцию. Известно, что наиболее распространёные карты - позднесоветские карты Генштаба имеют проекцию Pulkovo 1942 / Gauss-Krugger zone *. В проекции Гаусс-Крюггера земной шар разделён на зоны по мередианам через 6 градусов, и нам нужно её будет указать. Что бы узнать номер зоны - нужно приблизительно знать координаты места, изображённого на карте.  

Скачиваем схему зон Гаусс-Крюггера с гис-лаба на странице http://gis-lab.info/qa/kmgrids.html - ищем ссылку "Скачать разграфку в формате: Shape".

Открываем в :program:`NextGIS QGIS`. загруженный Shape, по желанию делаем его полупрозрачным. Подкладываем знакомую вам картоподложку плагином QuickMapServices, и находим место, которое изображено на топокарте.
В атрибутах файла схемы зон приведены номера зон UTM и Гаусс-Крюггера (поле называется GK). Запоминаем или записываем это число - это и будет **номер зоны Гаусс-Крюггера**.


.. figure:: _static/topo_zone_determine.png
   :name: topo_zone_determine.png
   :align: center
   :width: 15cm

   Определение зоны в NextGIS QGIS.



Так же может пригодится файл разграфки листов. Их можно скачать на странцие http://gis-lab.info/qa/topogrids.html, но вам нужно знать масштаб карты. В атрибутивной информации приведены названия листов (номенкалатура). Вы можете узнать, в какую зону попадает лист карты, если вы знаете его название, или узнать, какой лист карты искать, если вы знаете место.


Нужен растр в RGB
--------------------------

Посмотрите на файл с картой в файловом менеджере. Вам нужно определить формат файла. Если формат gif - то его нужно будет пересохранить в png, jpg, или tiff. Эту операцию можно сделать в графических редакторах, или в :program:`NextGIS QGIS`. :menuselection:`Растр --> Преобразование --> PCT в RGB`. 

Привязка
-------------------------

Начинаем привязку. В :program:`NextGIS QGIS` нажмите :menuselection:`Растр --> Привязка растров --> Привязка растров`. 


.. figure:: _static/topo_open_refrencing_window.png
   :name: topo_open_refrencing_window
   :align: center
   :width: 15cm

   Открытие окна привязки растров

Если этого пункта в меню нет - значит модуль не включён. В этом случае идите в настройку модулей :menuselection:`Модули --> Управление модулями`. Найдите модуль "Привязка растров" и включите его.

В окне привязки растров откройте файл с отсканированной картой.
На экран выведется диалог выбора системы координат. Поскольку этот файл ещё не привязан, то этот диалог мы закроем клавишей Отмена.


Приближаемся в левый верхний угол. 

Ищем на перекрестиях отметки метровых координат. Эти цифры обозначают миллионы метров.
Находим инструмент добавить точку, нажимаем на перекрестие. Появляется окно, вводим в X и Y - координаты в метрах. 
Нам нужно 9 точек.

Координаты X написаны за верхней и нижней границами, координаты Y - за правой и левой.
В них записаны миллионы метров, то есть если написано 6542 - то вводим с клавиатуры это число с тремя нулями: 6542000




После ввода 9 точек, идём в панель Параметры трансформации.
Выставляем 

* Тип трансформации - Полиноминальная 2
* Метод трансформации - Ланцоша
* Целевая система координат - Pulkovo 1942 / Gauss Krugger Zone - и тот номер зоны, который определили. В примере мы взяли Кировскую область, она попала в 9 - выставляем Pulkovo 1942 / Gauss-Kruger zone 9, EPSG:28409. В списке будут пункты с Deprecated, а нужно выбрать те, что без Deprecated.
* Целевой раст - имя нового GeoTIFF.


После указания параметров трансформации, и нажатия клавиши ОК - на экране покажутся ошибки трансформации.

Можно включить Параметры - Настройки привязки растров - включить идентификаторы, показать координаты.

.. figure:: _static/topo_refrencing_errors.png
   :name: topo_refrencing_errors
   :align: center
   :width: 15cm

   Пример привязки с большой ошибкой.

На картинке мы наблюдаем длинные красные линиии, а в строке состояния - большую среднюю ошибку. Это произошло из-за ошибки ввода цифровых координат.

Внимательно проверяем введёные цифры. После исправления цифр - заходим снова в окно Параметры трансформации, и нажимаем Ok - тогда пересчитывается средняя ошибка.


После исправления, значение средней ошибки уменьшилось с 400 до 1

Запускаем Файл --> Начать привязку растра.


Если всё получилось без ошибок, то в :program:`NextGIS QGIS` добавится геопривязанный растр в формате GeoTIFF. Вы можете проверить, как он ложится на слой OSM Mapnik (или под полупрозрачный слой OSM Mapnik).



.. figure:: _static/topo_refrencing_ok.png
   :name: topo_refrencing_ok
   :align: center
   :width: 15cm

   Карта привязанная точно.

